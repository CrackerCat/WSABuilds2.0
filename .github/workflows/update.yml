name: Check update
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  check:
    name: Check update
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ‚ôªÔ∏è
        uses: actions/checkout@v4

      - name: Install Dependencies üßë‚Äçüè≠
        run: |
          pip3 install beautifulsoup4 lxml

      - name: Create branch if not found üèóÔ∏è
        run: |
          git checkout -f update || git switch --discard-changes --orphan update

      - name: Get Magisk Stable Version ‚úÖ
        shell: python
        run: |
            import os
            import json
            import requests
            import logging
            import subprocess
            logging.captureWarnings(True)
            env_file = os.getenv('GITHUB_ENV')
            new_version_found = False
            currentver = requests.get(f"https://raw.githubusercontent.com/MustardChef/WSABuilds2.0/update/magiskstable.appversion").text.replace('\n', '')
            with open('magiskstable.appversion', 'w') as file:
                file.write(currentver)
            if not new_version_found:
                # Get latest version
                latestver = ""
                magiskstablemsg = ""
                latestver = json.loads(requests.get(f"https://github.com/topjohnwu/magisk-files/raw/master/stable.json").content)['magisk']['version'].replace('\n', '')
                magiskstablemsg="Update Magisk Stable Version from `v" + currentver + "` to `v" + latestver + "`"
                if currentver != latestver:
                    print("New version found: " + latestver)
                    new_version_found = True
                    # Write appversion content
                    with open('magiskstable.appversion', 'w+') as file:
                        file.seek(0)
                        file.truncate()
                        file.write(latestver)
                    # Write Github Environment
                    with open(env_file, "a") as wr:
                        wr.write(f"MAGISK_STABLE_MSG={magiskstablemsg}\n")
                file.close()      
                
      - name: Update App version üîó
        uses: stefanzweifel/git-auto-commit-action@v5.0.0
        with:
          branch: update
          push_options: '--force'
          file_pattern: '*.appversion'
          commit_message: ${{ env.MSG || 'Update App Version' }}
          create_branch: true
          
      - name: Delete old workflow run ‚ùå
        uses: Mattraks/delete-workflow-runs@v2.0.5
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 0
          delete_workflow_pattern: "Check update"
          
      - name: Checkout Again! üîÑ
        uses: actions/checkout@v4.1.1
        
    outputs:
      SHOULD_BUILD: ${{ env.SHOULD_BUILD }}
      INSIDER_BUILD: ${{ env.INSIDER }}
      WSA_UPDATE_MESSAGE: ${{ env.MSG }}
      MAGISK_CANARY_MSG: ${{ env.MAGISK_CANARY_MSG }}
      MAGISK_STABLE_MSG: ${{ env.MAGISK_STABLE_MSG }}
      KERNEL_SU_MSG: ${{ env.KERNEL_SU_MSG }}
      WIF_VER: ${{ env.LATEST_WIF_VER }}
      RETAIL_VER: ${{ env.LATEST_RETAIL_VER }}
      MTG_MSG: ${{ env.MTG_MSG }}
